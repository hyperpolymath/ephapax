# SPDX-License-Identifier: PMPL-1.0-or-later
name: Performance Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run benchmarks weekly on Monday at 00:00 UTC
    - cron: '0 0 * * 1'

permissions:
  contents: write  # For pushing benchmark results

jobs:
  benchmark:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Install Rust
        uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7 # stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Cache Cargo
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Install AssemblyScript dependencies
        run: |
          cd benches/comparison/assemblyscript
          npm install

      - name: Build Ephapax compiler
        run: cargo build --release

      - name: Run compilation time benchmarks
        run: cargo bench --bench compile_time -- --output-format bencher | tee compile_output.txt

      - name: Run binary size measurements
        run: cargo run --release --bin binary_size | tee size_output.txt

      - name: Run runtime performance benchmarks
        run: cargo bench --bench runtime_perf -- --output-format bencher | tee runtime_output.txt

      - name: Generate comparison report
        run: |
          python3 benches/scripts/compare_results.py

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: |
            target/criterion/
            benches/BENCHMARK-RESULTS.md
            compile_output.txt
            size_output.txt
            runtime_output.txt

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('benches/BENCHMARK-RESULTS.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸ“Š Benchmark Results\n\n${report}`
            });
